version: 2
sources:
  - name: recurly
    schema: "{{var ('recurly_schema', 'recurly')}}"
    database: "{{var ('recurly_database', target.database)}}"
    loader: Fivetran
    loaded_at_field: _fivetran_synced

    freshness:
      warn_after: { count: 72, period: hour }
      error_after: { count: 168, period: hour }

    tables:
      - name: account_balance_history
        description: The customer account balance is made up of any open or past due invoices on the account alongside any charge or credit adjustments that are left uninvoiced and open on the account respectively. 
        columns: 
          - name: _fivetran_synced
          - name: account_id
          - name: account_updated_at
          - name: balance_currency
          - name: balance_amount
          - name: past_due

      - name: account_note_history
        description: A history of notes your team can leave on an account to add context. Notes are internal and not exposed to customers.
        columns: 
          - name: _fivetran_synced
          - name: id
          - name: account_id
          - name: account_updated_at
          - name: object
          - name: user_id
          - name: user_email
          - name: message
          - name: created_at

      - name: account_history
        description: >
          The account object stores the entire Recurly history of your customer and 
          acts as the entry point for working with a customer's billing information, subscription data, transactions, invoices and more. 
          Once an account is created, all values (with the exception of the account code) may be updated. 
          The table holds the lineage of the account.
        columns:
          - name: _fivetran_synced
          - name: id
            description: Uniquely identifies your customers in Recurly. No two customers can share the same account id. Part of the PK
          - name: updated_at
            description: When the account was last changed. Part of the PK
          - name: created_at
            description: When the account was created.
          - name: deleted_at
            description: If present, when the account was last marked inactive.
          - name: code
            description: >
              The unique identifier of the account. This cannot be changed once the account is created. Provided during account creation.
          - name: bill_to
            description: >
              An enumerable describing the billing behavior of the account, 
              specifically whether the account is self-paying or will rely on the parent account to pay.
          - name: state
            description: Accounts can be either active or inactive.
          - name: username
            description: A secondary value for the account.
          - name: first_name
            description: The first name of the customer related to the account.
          - name: last_name
            description: The last name of the customer related to the account.
          - name: email
            description: >
              The email address used for communicating with this customer. 
              The customer will also use this email address to log into your hosted account management pages. 
              This value does not need to be unique.
          - name: cc_emails
            description: >
              Additional email address that should receive account correspondence. 
              These should be separated only by commas. 
              These CC emails will receive all emails that the email field also receives.
          - name: company
            description: The company related with the account.
          - name: vat_number
            description: The VAT number of the account (to avoid having the VAT applied). This is only used for manually collected invoices.
          - name: tax_exempt
            description: The tax status of the account. true exempts tax on the account, false applies tax on the account.

      - name: billing_info_history
        description: Stored payment information for an account. Filled out by the customer upon purchase or when they update information.
        columns:
          - name: _fivetran_synced
          - name: id
          - name: updated_at
          - name: account_id
          - name: first_name
          - name: last_name
          - name: company
          - name: billing_phone
          - name: billing_street_1
          - name: billing_street_2
          - name: billing_city
          - name: billing_region
          - name: billing_postal_code
          - name: billing_country
          - name: vat_number
          - name: valid
          - name: payment_method_object
          - name: payment_method_card_type
          - name: payment_method_first_six
          - name: payment_method_last_four
          - name: payment_method_exp_month
          - name: payment_method_exp_year
          - name: fraud_score
          - name: fraud_decision
          - name: fraud_risk_rules_triggered
          - name: created_at
          - name: updated_by_ip
          - name: updated_by_country
      
      - name: coupon_discount
        description: Coupon details and the discounts set for customer purchases.
        columns:
          - name: _fivetran_synced
          - name: fivetran_id
          - name: coupon_id
          - name: amount
          - name: currency
          - name: percentage
          - name: trial_length
          - name: trial_unit
          - name: type

      - name: coupon_redemption_history
        description: History of coupons redeemed by accounts.
        columns:
          - name: _fivetran_synced
          - name: id
          - name: updated_at
          - name: coupon_id
          - name: account_id
          - name: state
          - name: currency
          - name: discounted
          - name: created_at
          - name: removed_at
      
      - name: credit_payment_history
        description: A history of outstanding credit balance to pay an invoice, but does include the record of write-offs, credit balance removals, and credit payments later refunded as cash transaction.
        columns:
          - name: _fivetran_synced
          - name: id
          - name: updated_at
          - name: account_id
          - name: applied_to_invoice_id
          - name: original_invoice_id
          - name: refund_transaction_id
          - name: original_credit_payment_id
          - name: uuid
          - name: action
          - name: currency
          - name: amount
          - name: created_at
          - name: voided_at

      - name: invoice_coupon_redemption_history
        description: History of coupons redeemed and applied to specific invoices.
        columns:
          - name: _fivetran_synced
          - name: coupon_redemption_id
          - name: invoice_updated_at
          - name: invoice_id

      - name: invoice_history
        description: >
          An invoice relates charges, credits, and payments together. 
          When a subscription is created or renewed or a charge is created on the account, 
          Recurly will sum the charges, discount or tax as appropriate, and send the invoice out for collection. 
          The table holds the lineage of the invoice.
        columns:
          - name: _fivetran_synced
          - name: id
            description: Unique identifier for the object.
          - name: created_at
            description: When the invoice was created.
          - name: updated_at
            description: When the invoice was updated.
          - name: due_at
            description: Date invoice is due. This is the date the net terms are reached.
          - name: closed_at
            description: Date invoice was marked paid or failed.
          - name: account_id
            description: The account this invoice belongs to.
          - name: previous_invoice_id
            description: On refund invoices, this value will exist and show the invoice ID of the purchase invoice the refund was created from.
          - name: type
            description: Invoices are either "charge", "credit", or "legacy" invoices.
          - name: origin
            description: >
              The event that created the invoice.
              Enum: "credit", "gift_card", "immediate_change", "line_item_refund", "open_amount_refund", 
              "purchase", "renewal", "termination", "write_off", "prepayment".
          - name: state
            description: >
              The invoice state. 
              Enum: "open", "pending", "processing", "past_due", "paid", "closed", "failed", "voided"
          - name: number
            description: >
              If VAT taxation and the Country Invoice Sequencing feature are enabled, 
              invoices will have country-specific invoice numbers for invoices billed to EU countries (e.g. FR1001). 
              Non-EU invoices will continue to use the site-level invoice number sequence.
          - name: collection_method
            description: >
              An automatic invoice means a corresponding transaction is run using the account's billing information 
              at the same time the invoice is created. Manual invoices are created without a corresponding transaction. 
              The merchant must enter a manual payment transaction or have the customer pay the invoice with an automatic method, 
              like credit card, PayPal, Amazon, or ACH bank payment.
              Default: "automatic"
              Enum: "automatic", "manual"
          - name: po_number
            description: For manual invoicing, this identifies the PO number associated with the subscription.
          - name: net_terms
            description: >
              Integer representing the number of days after an invoice's creation that the invoice will become past due. 
              If an invoice's net terms are set to '0', it is due 'On Receipt' and will become past due 24 hours after it’s created. 
              If an invoice is due net 30, it will become past due at 31 days exactly.
              Default: 0
          - name: currency
            description: 3-letter ISO 4217 currency code.
          - name: balance
            description: The outstanding balance remaining on this invoice.
          - name: paid
            description: The total amount of successful payments transaction on this invoice.
          - name: refundable_amount
            description: The refundable amount on a charge invoice. It will be null for all other invoices.
          - name: discount
            description: Total discounts applied to this invoice.
          - name: total
            description: >
              The final total on this invoice. The summation of invoice charges, discounts, credits, and tax.
              Alternative the summation of subtotal and tax.
          - name: subtotal
            description: The summation of charges, discounts, and credits, before tax.
          - name: tax
            description: The total tax on this invoice.
          - name: tax_type
            description: >
              Provides the tax type as "vat" for EU VAT, "usst" for U.S. Sales Tax, 
              or the 2 letter country code for country level tax types like Canada, Australia, New Zealand, Israel, and all non-EU European countries.
          - name: tax_region
            description: >
              Provides the tax region applied on an invoice. For U.S. Sales Tax, 
              this will be the 2 letter state code. 
              For EU VAT this will be the 2 letter country code. 
              For all country level tax types, this will display the regional tax, like VAT, GST, or PST.
          - name: tax_rate
            description: The rate of the tax.

      - name: invoice_subscription_history
        description: >
          The connection between invoices and subscription. 
          FK on invoice are both invoice_id and invoice_updated_at, and on subscription is subscription_id.
          The table holds the lineage of the invoice - subscription connection.
        columns:
          - name: _fivetran_synced
          - name: invoice_id
            description: The id of the invoice associated with the subscription.
          - name: invoice_updated_at
            description: When the invoice was updated.
          - name: subscription_id
            description: The id of the subscription associated with the invoice.

      - name: line_item_history
        description: >
          Line items are the charges and credits on your customer's invoices.
          The table holds the lineage of the line item.
        columns:
          - name: _fivetran_synced
          - name: id
            description: Unique identifier for the object.
          - name: created_at
            description: When the line item was created.
          - name: updated_at
            description: When the line item was updated.
          - name: account_id
            description: The account this line item belongs to.
          - name: previous_line_item_id
            description: >
              Will only have a value if the line item is a credit created from a previous credit, 
              or if the credit was created from a charge refund.
          - name: invoice_id
            description: Once the line item has been invoiced this will be the invoice's ID.
          - name: original_line_item_invoice_id
            description: >
              The invoice where the credit originated. 
              Will only have a value if the line item is a credit created from a previous credit, 
              or if the credit was created from a charge refund.
          - name: plan_id
            description: If the line item is a charge or credit for a plan or add-on, this is the plan's ID.
          - name: plan_code
            description: If the line item is a charge or credit for a plan or add-on, this is the plan's code.
          - name: add_on_id
            description: If the line item is a charge or credit for an add-on this is its ID.
          - name: add_on_code
            description: If the line item is a charge or credit for an add-on, this is its code.
          - name: subscription_id
            description: If the line item is a charge or credit for a subscription, this is its ID.
          - name: uuid
            description: The UUID is useful for matching data with the CSV exports and building URLs into Recurly's UI. Used in HTB database.
          - name: type
            description: >
              Charges are positive line items that debit the account. 
              Credits are negative line items that credit the account.
              Enum: "charge", "credit"
          - name: state
            description: >
              Pending line items are charges or credits on an account that have not been applied to an invoice yet. 
              Invoiced line items will always have an invoice_id value.
              Enum: "invoiced", "pending"
          - name: invoice_number
            description: >
              Once the line item has been invoiced this will be the invoice's number. 
              If VAT taxation and the Country Invoice Sequencing feature are enabled, 
              invoices will have country-specific invoice numbers for invoices billed to EU countries (e.g. FR1001). 
              Non-EU invoices will continue to use the site-level invoice number sequence.
          - name: origin
            description: >
              A credit created from an original charge will have the value of the charge's origin.
              Enum: "add_on", "add_on_trial", "carryforward", "coupon", "credit", "debit", "one_time", 
              "plan", "plan_trial", "setup_fee", "prepayment"
          - name: product_code
            description: >
              For plan-related line items this will be the plan's code, for add-on related line items it will be the add-on's code. 
              For item-related line items it will be the item's external_sku.
          - name: currency
            description: 3-letter ISO 4217 currency code.
          - name: amount
            description: Total after discounts and taxes (quantity * unit_amount) - (discount + tax).
          - name: description
            description: Description that appears on the invoice. For subscription related items this will be filled in automatically.
          - name: quantity
            description: >
              This number will be multiplied by the unit amount to compute the subtotal before any discounts or taxes.
              Default: 1
          - name: unit_amount
            description: Positive amount for a charge, negative amount for a credit.
          - name: subtotal
            description: Total before discounts and taxes (quantity * unit_amount).
          - name: discount
            description: The discount applied to the line item.
          - name: tax
            description: The tax amount for the line item.
          - name: taxable
            description: true if the line item is taxable, false if it is not.
          - name: tax_exempt
            description: >
              true exempts tax on charges, false applies tax on charges. If not defined, then defaults to the Plan and Site settings. 
              This attribute does not work for credits (negative line items). Credits are always applied post-tax. 
              Pre-tax discounts should use the Coupons feature.
          - name: tax_code
            description: >
              Used by Avalara, Vertex, and Recurly’s EU VAT tax feature. The tax code values are specific to each tax system. 
              If you are using Recurly’s EU VAT feature you can use unknown, physical, or digital.
          - name: tax_type
            description: >
              Provides the tax type as "vat" for EU VAT, "usst" for U.S. Sales Tax, or the 2 letter country code for country level tax types 
              like Canada, Australia, New Zealand, Israel, and all non-EU European countries.
          - name: tax_region
            description: >
              Provides the tax region applied on an invoice. 
              For U.S. Sales Tax, this will be the 2 letter state code. 
              For EU VAT this will be the 2 letter country code. 
              For all country level tax types, this will display the regional tax, like VAT, GST, or PST.
          - name: tax_rate
            description: Tax rate
          - name: proration_rate
            description: >
              When a line item has been prorated, this is the rate of the proration. 
              Proration rates were made available for line items created after March 30, 2017. 
              For line items created prior to that date, the proration rate will be null, even if the line item was prorated.
          - name: refund
            description: true if the line item is refund, false if it is not.
          - name: refunded_quantity
            description: For refund charges, the quantity being refunded. For non-refund charges, the total quantity refunded (possibly over multiple refunds).
          - name: credit_applied
            description: The amount of credit from this line item that was applied to the invoice.
          - name: start_date
            description: >
              If an end date is present, this is value indicates the beginning of a billing time range. 
              If no end date is present it indicates billing for a specific date.
          - name: end_date
            description: If this date is provided, it indicates the end of a time range

      - name: plan_currency_history
        description: Plan prices
        columns:
          - name: _fivetran_synced
          - name: plan_id
            description: The id of the plan. 
          - name: plan_updated_at
            description: plan_updated_at
          - name: currency
            description: currency
          - name: setup_fees
            description: setup_fees
          - name: unit_amount
            description: unit_amount

      - name: plan_history
        description: >
          Plans define the base price, currency, and billing cycle for recurring purchases of products.
          The table holds the lineage of the plan.
        columns:
          - name: id
            description: Unique identifier for the object.
          - name: created_at
            description: When the plan was created.
          - name: updated_at
            description: When the plan was updated.
          - name: deleted_at
            description: When the plan was deleted.
          - name: code
            description: Unique code to identify the plan. This is used in Hosted Payment Page URLs and in the invoice exports.
          - name: state
            description: >
              The current state of the plan.
              Enum: "active", "inactive"
          - name: name
            description: This name describes your plan and will appear on the Hosted Payment Page and the subscriber's invoice.
          - name: description
            description: Optional description, not displayed.
          - name: interval_unit
            description: >
              Unit for the plan's billing interval.
              Default: "months"
              Enum: "days", "months"
          - name: interval_length
            description: >
              Length of the plan's billing interval in interval_unit.
              Default: 1
          - name: trial_unit
            description: >
              Units for the plan's trial period.
              Default: "months"
              Enum: "days", "months"
          - name: trial_length
            description: >
              Length of plan's trial period in trial_units. 0 means no trial.
              Default: 0
          - name: total_billing_cycles
            description: >
              Automatically terminate subscriptions after a defined number of billing cycles. 
              Number of billing cycles before the plan automatically stops renewing, defaults to null for continuous, automatic renewal.
          - name: auto_renew
            description: >
              Subscriptions will automatically inherit this value once they are active. 
              If auto_renew is true, then a subscription will automatically renew its term at renewal. 
              If auto_renew is false, then a subscription will expire at the end of its term. 
              auto_renew can be overridden on the subscription record itself.
              Default: true
          - name: accounting_code
            description: Accounting code for invoice line items for the plan. If no value is provided, it defaults to plan's code.
          - name: setup_fee_accounting_code
            description: Accounting code for invoice line items for the plan's setup fee. If no value is provided, it defaults to plan's accounting code.
          - name: tax_code
            description: >
              Used by Avalara, Vertex, and Recurly’s EU VAT tax feature. The tax code values are specific to each tax system. 
              If you are using Recurly’s EU VAT feature you can use unknown, physical, or digital.
          - name: tax_exempt
            description: true exempts tax on the plan, false applies tax on the plan.

      - name: subscription_add_on_history
        description: History of subscription add-ons to a particular plan. 
        columns:
          - name: _fivetran_synced
          - name: id
          - name: updated_at
          - name: subscription_id
          - name: plan_add_on_id
          - name: object
          - name: unit_amount
          - name: quantity
          - name: created_at
          - name: expired_at

      - name: subscription_change_history
        description: History of subscription changes, particularly upgrades and downgrades, but also changes to how subscription is invoiced.
        columns:
          - name: _fivetran_synced
          - name: id
          - name: updated_at
          - name: plan_id
          - name: subscription_id
          - name: object
          - name: unit_amount
          - name: quantity
          - name: activate_at
          - name: activated
          - name: created_at
          - name: deleted_at
      
      - name: subscription_history
        description: >
          Subscriptions are created when your customers subscribe to one of your plans. 
          The customer's subscription tells Recurly when and how much to bill the customer.
          The table holds the lineage of the subscription.
        columns:
          - name: _fivetran_synced
          - name: id
            description: Unique identifier for the object.
          - name: created_at
            description: When the subscription was created.
          - name: updated_at
            description: When the subscription was updated.
          - name: activated_at
            description: When the subscription was activated.
          - name: canceled_at
            description: When the subscription was canceled. Can take future dates.
          - name: expires_at
            description: When the subscription has expired. Can take future dates.
          - name: account_id
            description: The account this subscription belongs to.
          - name: plan_id
            description: The plan this subscription belongs to.
          - name: object
            description: The object type, in this case only "subscription"
          - name: uuid
            description: The UUID is useful for matching data with the CSV exports and building URLs into Recurly's UI.
          - name: state
            description: >
              The current state of the subscription.
              Enum: "active", "canceled", "expired", "failed", "future", "paused"
          - name: current_period_start
            description: Current billing period started at.
          - name: current_period_end
            description: Current billing period ends at)
          - name: current_term_start
            description: >
              The start date of the term when the first billing period starts. 
              The subscription term is the length of time that a customer will be committed to a subscription. 
              A term can span multiple billing periods.
          - name: current_term_end
            description: >
              When the term ends. This is calculated by a plan's interval and total_billing_cycles in a term. 
              Subscription changes with a timeframe=renewal will be applied on this date.
          - name: trial_started_at
            description: Trial period started at
          - name: trial_ends_at
            description: Trial period ends at
          - name: remaining_billing_cycles
            description: The remaining billing cycles in the current term.
          - name: total_billing_cycles
            description: >
              The number of cycles/billing periods in a term. 
              When remaining_billing_cycles=0, if auto_renew=true the subscription will renew and a new term will begin, 
              otherwise the subscription will expire.
          - name: renewal_billing_cycles
            description: >
              If auto_renew=true, when a term completes, total_billing_cycles takes this value as the length of subsequent terms. 
              Defaults to the plan's total_billing_cycles.
          - name: auto_renew
            description: >
              Whether the subscription renews at the end of its term.
              Default: true
          - name: paused_at
            description: Null unless subscription is paused or will pause at the end of the current billing period.
          - name: remaining_pause_cycles
            description: Null unless subscription is paused or will pause at the end of the current billing period.
          - name: currency
            description: 3-letter ISO 4217 currency code.
          - name: unit_amount
            description: Subscription unit price
          - name: subtotal
            description: Estimated total, before tax.
          - name: quantity
            description: Subscription quantity. Greater or equal to 0.
          - name: add_ons_total
            description: Total price of add-ons. Greater or equal to 0.
          - name: collection_method
            description: >
              Default: "automatic"
              Enum: "automatic", "manual"
          - name: expiration_reason
            description: Expiration reason

      - name: transaction_subscription
        description: >
          The connection between transaction and subscription. 
          FK on transaction is transaction_id, and on subscription is subscription_id.
          The table holds the lineage of the transaction - subscription connection.
        columns:
          - name: _fivetran_synced
          - name: transaction_id
            description: The id of the transaction associated with the subscription.
          - name: subscription_id
            description: The id of the subscription associated with the transaction.

      - name: transaction
        description: >
          Purchasing information is sent to your payment gateway in an action called a transaction. 
          This includes the customer's billing information and the amount of money to be charged, voided, or refunded.
        columns:
          - name: _fivetran_synced
          - name: id
            description: Unique identifier for the object.
          - name: created_at
            description: When the transaction was created.
          - name: voided_at
            description: When the transaction was voided.
          - name: collected_at
            description: When the transaction was collected.
          - name: original_transaction_id
            description: If this transaction is a refund (type=refund), this will be the ID of the original transaction on the invoice being refunded.
          - name: account_id
            description: The account_id this transaction belongs to.
          - name: invoice_id
            description: The invoice_id this transaction belongs to.
          - name: voided_by_invoice_id
            description: The invoice_id this transaction was voided.
          - name: uuid
            description: The UUID is useful for matching data with the CSV exports and building URLs into Recurly's UI.
          - name: type
            description: >
              Transaction types:
                authorization – verifies billing information and places a hold on money in the customer's account.
                capture – captures funds held by an authorization and completes a purchase.
                purchase – combines the authorization and capture in one transaction.
                refund – returns all or a portion of the money collected in a previous transaction to the customer.
                verify – a $0 or $1 transaction used to verify billing information which is immediately voided.
              Enum: "authorization", "capture", "purchase", "refund", "verify"
          - name: origin
            description: >
              Describes how the transaction was triggered.
              Enum: "api", "chargeback", "force_collect", "hpp", "merchant", "recurly_admin", "recurlyjs", "recurring", "refunded_externally", "transparent"
          - name: currency
            description: 3-letter ISO 4217 currency code.
          - name: amount
            description: Total transaction amount sent to the payment gateway.
          - name: status
            description: >
              The current transaction status. Note that the status may change, e.g. a pending transaction may become declined or success may later become void.
              Enum: "chargeback", "declined", "error", "pending", "processing", "scheduled", "success", "void"
          - name: success
            description: Did this transaction complete successfully?
          - name: refunded
            description: Indicates if part or all of this transaction was refunded.
          - name: billing_first_name
            description: Billing info - First name
          - name: billing_last_name
            description: Billing info - Last name
          - name: billing_phone
            description: Billing info - Phone
          - name: billing_street_1
            description: Billing info - Address Street 1
          - name: billing_street_2
            description: Billing info - Address Street 2
          - name: billing_city
            description: Billing info - City
          - name: billing_region
            description: Billing info - State or province.
          - name: billing_postal_code
            description: Billing info - Zip or postal code.
          - name: billing_country
            description: Billing info - Country, 2-letter ISO code.
          - name: collection_method
            description: >
              The method by which the payment was collected.
              Enum: "automatic", "manual"
          - name: payment_method_object
            description: >
              Enum: "amazon", "amazon_billing_agreement", "apple_pay", "bank_account_info", "check", "credit_card", "eft", 
              "gateway_token", "iban_bank_account", "money_order", "other", "paypal", "paypal_billing_agreement", "roku", 
              "sepadirectdebit", "wire_transfer"
          - name: status_code
            description: Status code of the transaction
          - name: status_message
            description: For declined (success=false) transactions, the message displayed to the merchant.
          - name: customer_message
            description: For declined (success=false) transactions, the message displayed to the customer.
          - name: customer_message_locale
            description: Language code for the message
          - name: gateway_message
            description: Transaction message from the payment gateway.
          - name: gateway_reference
            description: Transaction reference number from the payment gateway.
          - name: gateway_approval_code
            description: Transaction approval code from the payment gateway.
          - name: gateway_response_code
            description: For declined transactions (`success=false`), this field lists the gateway error code.
          - name: gateway_response_time
            description: Time, in seconds, for gateway to process the transaction.
          - name: payment_gateway_id
            description: Payment gateway id
          - name: payment_gateway_type
            description: Payment gateway type
          - name: payment_gateway_name
            description: Payment gateway name
          - name: gateway_response_values
            description: The values in this field will vary from gateway to gateway.

